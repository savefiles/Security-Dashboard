<?php 
// Script recieves data from the client, and will either return cached data or take the new data as data from the last day.
// Client sends each day as a seperate piece of data, and it gets stored in a seperate file?
// Server will check to see which files need to be removed.

// Only accept post requests.
if ($_SERVER['REQUEST_METHOD'] != 'POST') {
    exit;
}

$queryType = $_SERVER['HTTP_QUERY_TYPE'];
// The user is requesting data from the server. The server will send data and possibly request the client to query API.
if($queryType == "Fetch") {
    http_response_code(200);

    // Create the json objects to return.
    $dataToReturn = array();
    $dataToReturn['data'] = [];
    $timestampsToQuery = array();
    $timestampsToQuery['timestamps'] = [];

    // 00:00 time, current day.
    $today = date_time_set(date_create(), 0, 0, 0, 0);
    for($i = 0; $i < 30; $i++) {
        // Go back i number of days.
        $dateInterval = new DateInterval('P' . 1 . 'D');
        $date = date_sub($today, $dateInterval);
        $timestamp = date_timestamp_get($date) * 1000;
        $filename = "json/" . $timestamp . ".json";

        if(file_exists($filename)) {
            // Get the file.
            $data = json_decode(file_get_contents($filename), true);

            // Pass the data into an object, and into the returned array.
            $dataObject['date'] = $timestamp;
            $dataObject['data'] = $data;
            $dataToReturn['data'][] = $dataObject;
        }
        else {
            // Add the timestamp to query array.
            $timestampsToQuery['timestamps'][] = $timestamp;
        }
    }

    // Return the data.
    echo json_encode([$timestampsToQuery, $dataToReturn], true);

}
// The user is sending the data that the server requested.
elseif($queryType == "Update") {
    http_response_code(200);
    
    $input = file_get_contents('php://input');
    $json = json_decode($input, true);  // Need to set as true to properly parse arrays instead of objects.
    //echo print_r($json);
    $arrayOfDays = $json['data'];

    // Split each day into a seperate file.
    foreach($arrayOfDays as $day) {
        $filename = "json/" . $day['date'] . ".json";
        $data = $day['data'];

        // DO NOT OVERRITE EXISTING FILES
        if(!file_exists($filename)) {
            file_put_contents($filename, json_encode($data));
        }
    }
}
// Malformed request.
else {
    http_response_code(400);
    echo "Malformed request.";
}
?>